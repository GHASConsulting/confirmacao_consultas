# üè• Sistema de Confirma√ß√£o de Consultas - Santa Casa

Sistema automatizado para confirma√ß√£o de consultas m√©dicas via WhatsApp, integrado com Botconversa API e N8N para automa√ß√£o completa.

## üöÄ **Funcionalidades Principais**

- ‚úÖ **Integra√ß√£o Botconversa**: Gest√£o de subscribers, campanhas e fluxos
- ü§ñ **Scheduler Automatizado**: Confirma√ß√µes, lembretes e monitoramento de novos atendimentos
- üîÑ **Webhook Inteligente**: Processamento de respostas via N8N
- üìä **CLI Robusto**: Interface de linha de comando para testes e administra√ß√£o
- üê≥ **Docker Ready**: Containeriza√ß√£o completa com suporte a Oracle, PostgreSQL e Firebird
- üì± **Monitoramento Autom√°tico**: Detec√ß√£o autom√°tica de novos atendimentos
- üîå **Webhook N8N**: Processamento autom√°tico de respostas dos pacientes
- üõ°Ô∏è **Tratamento de Erros**: Sistema robusto com rollback controlado

## üõ†Ô∏è **Tecnologias**

- **Backend**: FastAPI + Python 3.11
- **Banco**: Suporte a Oracle, PostgreSQL e Firebird
- **ORM**: SQLAlchemy
- **Scheduler**: APScheduler
- **CLI**: Click + Rich
- **Containeriza√ß√£o**: Docker + Docker Compose
- **Integra√ß√£o**: Botconversa API + N8N
- **Webhook**: Endpoint robusto para processamento de respostas

## üöÄ **Primeiros Passos (5 minutos)**

### **Para testar rapidamente em uma nova m√°quina:**

```bash
# 1. Clone o reposit√≥rio
git clone <seu-repositorio>
cd confirmacao_consultas

# 2. Execute a instala√ß√£o autom√°tica
./install.sh          # Linux/Mac
# ou
install.bat           # Windows

# 3. Configure o .env com suas chaves Botconversa
# 4. Acesse: http://localhost:8000
```

**üéØ Resultado**: Sistema completo rodando com PostgreSQL em menos de 5 minutos!

---

## üìã **Pr√©-requisitos**

- Python 3.11+ (para instala√ß√£o local)
- Docker e Docker Compose (para instala√ß√£o Docker)
- Conta Botconversa com API Key
- Git

## üöÄ **INSTALA√á√ÉO AUTOM√ÅTICA (RECOMENDADA)**

### **üêß Linux/Mac:**

```bash
# 1. Clone o reposit√≥rio
git clone <seu-repositorio>
cd confirmacao_consultas

# 2. Torne execut√°vel e execute
chmod +x install.sh
./install.sh
```

### **ü™ü Windows:**

```cmd
# 1. Clone o reposit√≥rio
git clone <seu-repositorio>
cd confirmacao_consultas

# 2. Execute a instala√ß√£o
install.bat
```

### **‚ö° Setup R√°pido Docker (Linux/Mac):**

```bash
# Torne execut√°vel
chmod +x setup-docker.sh

# PostgreSQL (padr√£o)
./setup-docker.sh

# Oracle
./setup-docker.sh oracle

# Firebird
./setup-docker.sh firebird
```

### **üéØ O que os scripts fazem automaticamente:**

‚úÖ Verificam se Docker est√° instalado e rodando  
‚úÖ Verificam se Docker Compose est√° dispon√≠vel  
‚úÖ Verificam se Git est√° instalado  
‚úÖ Instalam Make se necess√°rio  
‚úÖ Criam arquivo .env a partir do template  
‚úÖ Constr√≥em imagens Docker  
‚úÖ Iniciam servi√ßos com PostgreSQL  
‚úÖ Testam a instala√ß√£o  
‚úÖ Mostram pr√≥ximos passos

---

## üê≥ **Docker (Configura√ß√£o Manual)**

### **Setup R√°pido com Docker:**

```bash
# 1. Clone o reposit√≥rio
git clone <seu-repositorio>
cd confirmacao_consultas

# 2. Configure as vari√°veis de ambiente
cp env.example .env
# Edite o .env com suas configura√ß√µes

# 3. Inicie os servi√ßos (escolha o banco)
make postgresql-setup    # Para PostgreSQL
make oracle-setup        # Para Oracle
make firebird-setup      # Para Firebird

# 4. Verifique o status
make status
```

### **Configura√ß√£o do .env para Docker:**

**IMPORTANTE**: Configure estas vari√°veis no seu `.env`:

```bash
# ========================================
# ESCOLHA DO BANCO DOCKER
# ========================================
DOCKER_DATABASE_TYPE=postgresql  # oracle, postgresql, firebird

# ========================================
# CONFIGURA√á√ïES BOTCONVERSA (OBRIGAT√ìRIAS)
# ========================================
BOTCONVERSA_API_KEY=sua_api_key_real_aqui
BOTCONVERSA_WEBHOOK_SECRET=seu_webhook_secret_real_aqui
WEBHOOK_URL=https://seudominio.com/webhook/botconversa

# ========================================
# CONFIGURA√á√ïES DO HOSPITAL
# ========================================
HOSPITAL_NAME=Santa Casa de Belo Horizonte
HOSPITAL_PHONE=(31) 3238-8100
HOSPITAL_ADDRESS=Rua Domingos Vieira, 590 - Santa Efig√™nia
HOSPITAL_CITY=Belo Horizonte
HOSPITAL_STATE=MG
```

### **Comandos Docker Dispon√≠veis:**

```bash
# Comandos principais
make help                    # Mostra todos os comandos dispon√≠veis
make build                   # Constr√≥i as imagens Docker
make up                      # Inicia servi√ßos (usa banco do .env)
make down                    # Para servi√ßos
make logs                    # Mostra logs
make status                  # Status dos servi√ßos

# Setup espec√≠fico por banco
make postgresql-setup        # Inicia com PostgreSQL
make oracle-setup            # Inicia com Oracle
make firebird-setup          # Inicia com Firebird
make dev                     # Setup padr√£o (PostgreSQL)

# Banco de dados
make db-shell-postgresql     # Shell PostgreSQL
make db-shell-oracle         # Shell Oracle
make db-shell-firebird       # Shell Firebird
make db-reset                # Reseta banco de dados

# Desenvolvimento
make shell                   # Acessa shell do container
make cli                     # Executa CLI da aplica√ß√£o
make test                    # Executa testes

# Monitoramento
make health                  # Verifica sa√∫de da aplica√ß√£o
make scheduler-status        # Status do scheduler

# Limpeza
make clean                   # Limpa tudo (containers, volumes, imagens)
make restart                 # Reinicia todos os servi√ßos
```

### **Como Escolher o Banco:**

1. **PostgreSQL (Recomendado para desenvolvimento):**

   ```bash
   DOCKER_DATABASE_TYPE=postgresql
   make postgresql-setup
   ```

2. **Oracle:**

   ```bash
   DOCKER_DATABASE_TYPE=oracle
   make oracle-setup
   ```

3. **Firebird:**
   ```bash
   DOCKER_DATABASE_TYPE=firebird
   make firebird-setup
   ```

### **Troubleshooting Docker:**

**Erro de porta em uso:**

```bash
# Verifique portas em uso
netstat -tulpn | grep :8000
netstat -tulpn | grep :5432

# Pare servi√ßos conflitantes ou mude portas no .env
APP_PORT=8001
POSTGRESQL_DOCKER_PORT=5433
```

**Erro de permiss√£o Docker:**

```bash
# Adicione usu√°rio ao grupo docker
sudo usermod -aG docker $USER
# Fa√ßa logout e login novamente
```

**Limpar tudo e recome√ßar:**

```bash
make clean                   # Remove tudo
make build                   # Reconstr√≥i
make postgresql-setup        # Inicia novamente
```

## üîß **Instala√ß√£o Local (Sem Docker)**

### **1. Configura√ß√£o do Ambiente:**

```bash
# Crie um ambiente virtual
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate     # Windows

# Instale depend√™ncias
pip install -r requirements.txt
```

### **2. Configura√ß√£o do Banco:**

```bash
# Configure as vari√°veis no .env
cp env.example .env
# Edite o .env com suas configura√ß√µes de banco

# Inicialize o banco
python -m app.database.init_db
```

### **3. Execu√ß√£o:**

```bash
# Inicie a aplica√ß√£o
python -m app.main

# Em outro terminal, execute o CLI
python -m cli help                    # Ver ajuda completa
python -m cli status                  # Ver status do sistema
python -m cli test-db                 # Testar banco de dados
python -m cli test-conexao            # Testar Botconversa
```

## üì± **Usando o CLI**

O CLI oferece comandos para todas as opera√ß√µes principais:

```bash
# Testes de conex√£o
python -m cli test-db          # Testa conex√£o com banco
python -m cli test-conexao     # Testa API Botconversa

# Gest√£o de atendimentos
python -m cli atendimentos              # Lista todos os atendimentos
python -m cli listar-atendimentos       # Lista atendimentos pendentes
python -m cli buscar-atendimento        # Busca atendimento por telefone
python -m cli criar-atendimento         # Cria novo atendimento

# Opera√ß√µes Botconversa
python -m cli adicionar-botconversa     # Adiciona subscriber no Botconversa
python -m cli enviar-mensagem           # Envia mensagem personalizada
python -m cli executar-workflow         # Executa workflow completo
python -m cli processar-resposta        # Processa resposta do paciente
python -m cli adicionar-campanha        # Adiciona na campanha

# Status e monitoramento
python -m cli status                    # Status geral do sistema
python -m cli help                      # Ajuda detalhada
```

## üîó **Webhook e N8N**

### **Endpoint do Webhook:**

```
POST /webhook/botconversa
```

### **Payload N8N Esperado:**

```json
{
  "telefone": "5511999999999",
  "subscriber_id": 123456,
  "resposta": "1" // "1" = SIM, "0" = N√ÉO
}
```

### **Configura√ß√£o N8N:**

1. Configure o webhook no N8N para enviar POST para sua URL
2. Formate o payload conforme especificado acima
3. A aplica√ß√£o processar√° automaticamente as respostas

### **Testando o Webhook:**

#### **Com Insomnia/Postman:**
```bash
POST http://101.44.2.109:5001/webhook/botconversa
Headers: Content-Type: application/json
Body: {
  "telefone": "5591982636266",
  "subscriber_id": "791023626",
  "resposta": "1"
}
```

#### **Com curl:**
```bash
curl -X POST http://101.44.2.109:5001/webhook/botconversa \
  -H "Content-Type: application/json" \
  -d '{
    "telefone": "5591982636266",
    "subscriber_id": "791023626",
    "resposta": "1"
  }'
```

### **Resposta do Webhook:**

```json
{
  "success": true,
  "message": "Webhook processado com sucesso",
  "data": {
    "success": true,
    "message": "Atendimento CONFIRMADO com sucesso",
    "atendimento_id": 2,
    "status": "CONFIRMADO",
    "telefone": "5591982636266",
    "subscriber_id": "791023626",
    "resposta": "1"
  }
}
```

## üõ°Ô∏è **Solu√ß√£o de Problemas Implementados**

### **‚úÖ Rollback Autom√°tico Resolvido:**

O sistema agora possui tratamento robusto de erros:

- **Commit final for√ßado** para evitar rollbacks autom√°ticos
- **Tratamento de exce√ß√µes** aprimorado
- **Middleware de logging** protegido contra falhas
- **Rollback controlado** apenas quando necess√°rio

### **‚úÖ Firewall e Conectividade:**

- **Porta 5001** configurada e aberta
- **IPTables** configurado para permitir conex√µes externas
- **Docker** expondo porta corretamente
- **Conectividade externa** testada e funcionando

### **‚úÖ Webhook Robusto:**

- **Valida√ß√£o de dados** implementada
- **Processamento de respostas** automatizado
- **Atualiza√ß√£o de status** no banco de dados
- **Logs detalhados** para debugging

## ‚è∞ **Scheduler Automatizado**

O sistema executa automaticamente:

- **Confirma√ß√µes**: Diariamente √†s 9h (configur√°vel)
- **Lembretes**: Diariamente √†s 14h (configur√°vel)
- **Monitoramento**: A cada 30 minutos para novos atendimentos

### **Configura√ß√£o dos Hor√°rios:**

```bash
SCHEDULER_CONFIRMATION_HOUR=9      # Hora das confirma√ß√µes
SCHEDULER_CONFIRMATION_MINUTE=0    # Minuto das confirma√ß√µes
SCHEDULER_REMINDER_HOUR=14         # Hora dos lembretes
SCHEDULER_REMINDER_MINUTE=0        # Minuto dos lembretes
```

## üìä **Monitoramento**

### **Endpoints de Status:**

- `GET /health` - Sa√∫de da aplica√ß√£o
- `GET /scheduler/status` - Status detalhado do scheduler

### **Logs:**

- Logs s√£o salvos em `./logs/`
- N√≠vel configur√°vel via `LOG_LEVEL` no `.env`

## üöÄ **Deploy em Produ√ß√£o**

### **1. Com Docker (Recomendado):**

```bash
# Configure o .env para produ√ß√£o
cp env.example .env
# Edite com configura√ß√µes de produ√ß√£o

# Inicie com Nginx
make prod

# Verifique status
make status
```

### **2. Configura√ß√µes de Produ√ß√£o:**

```bash
# Desabilite debug
DEBUG=false

# Configure host e porta
WEBHOOK_HOST=0.0.0.0
WEBHOOK_PORT=8000

# Configure URL p√∫blica
WEBHOOK_URL=https://seudominio.com/webhook/botconversa

# Ajuste workers
MAX_WORKERS=4
WORKER_TIMEOUT=30
```

### **3. Configura√ß√£o de Firewall (Produ√ß√£o):**

```bash
# Abrir porta 5001 para webhook
iptables -A INPUT -p tcp --dport 5001 -j ACCEPT

# Salvar regras
iptables-save > /etc/iptables/rules.v4

# Verificar status
iptables -L -n
```

## üìÅ **Estrutura do Projeto**

```
confirmacao_consultas/
‚îú‚îÄ‚îÄ app/                    # Aplica√ß√£o principal
‚îÇ   ‚îú‚îÄ‚îÄ api/               # Endpoints da API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/        # Rotas da API
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ webhook.py # Webhook para N8N
‚îÇ   ‚îú‚îÄ‚îÄ config/            # Configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ database/          # Modelos e conex√£o DB
‚îÇ   ‚îú‚îÄ‚îÄ services/          # L√≥gica de neg√≥cio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ webhook_service.py    # Servi√ßo do webhook
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ botconversa_service.py # Servi√ßo Botconversa
‚îÇ   ‚îî‚îÄ‚îÄ scheduler.py       # Scheduler automatizado
‚îú‚îÄ‚îÄ cli/                   # Interface de linha de comando
‚îú‚îÄ‚îÄ docs/                  # Documenta√ß√£o
‚îú‚îÄ‚îÄ logs/                  # Logs da aplica√ß√£o
‚îú‚îÄ‚îÄ Dockerfile             # Imagem Docker
‚îú‚îÄ‚îÄ docker-compose.yml     # Orquestra√ß√£o Docker (m√∫ltiplos bancos)
‚îú‚îÄ‚îÄ init-*.sql             # Scripts de inicializa√ß√£o dos bancos
‚îú‚îÄ‚îÄ Makefile               # Automa√ß√£o de comandos
‚îú‚îÄ‚îÄ requirements.txt       # Depend√™ncias Python
‚îú‚îÄ‚îÄ .env                   # Vari√°veis de ambiente
‚îú‚îÄ‚îÄ install.sh             # üöÄ Script de instala√ß√£o Linux/Mac
‚îú‚îÄ‚îÄ install.bat            # üöÄ Script de instala√ß√£o Windows
‚îú‚îÄ‚îÄ setup-docker.sh        # ‚ö° Setup r√°pido Docker
‚îî‚îÄ‚îÄ README-INSTALACAO.md   # üìñ Guia completo de instala√ß√£o
```

## üîç **Testes e Valida√ß√£o**

### **Testes Automatizados:**

```bash
# Com Docker
make test

# Local
pytest
```

### **Testes Manuais:**

```bash
# Teste CLI
python -m cli test-db
python -m cli test-conexao

# Teste API
curl http://localhost:8000/health
curl http://localhost:8000/scheduler/status

# Teste Webhook
curl -X POST http://localhost:8000/webhook/botconversa \
  -H "Content-Type: application/json" \
  -d '{"telefone": "5511999999999", "subscriber_id": "123", "resposta": "1"}'
```

## üìö **Documenta√ß√£o Adicional**

- üìñ [Guia de Desenvolvimento](docs/development_guide.md)
- üîß [Documenta√ß√£o T√©cnica](docs/TECHNICAL.md)
- üîÑ [Fluxo Botconversa](docs/fluxo_botconversa_consultas.md)
- üåê [Guia Webhook N8N](docs/webhook_n8n_guide.md)
- ‚úÖ [Implementa√ß√µes Completadas](IMPLEMENTACOES_COMPLETADAS.md)
- üöÄ **[Guia de Instala√ß√£o Completo](README-INSTALACAO.md)** ‚≠ê **NOVO!**

## üÜò **Suporte e Troubleshooting**

### **Problemas Comuns:**

1. **Erro de conex√£o com banco:**

   - Verifique `DATABASE_TYPE` e URLs no `.env`
   - Confirme se o banco Docker est√° rodando
   - Use `make status` para verificar servi√ßos

2. **Erro Botconversa:**

   - Valide `BOTCONVERSA_API_KEY` no `.env`
   - Teste com `python -m cli test-conexao`

3. **Scheduler n√£o funciona:**

   - Verifique `make scheduler-status`
   - Confirme hor√°rios no `.env`

4. **Erro Docker:**
   - Use `make clean` para limpar tudo
   - Verifique portas dispon√≠veis
   - Confirme `DOCKER_DATABASE_TYPE` no `.env`

5. **Webhook n√£o funciona externamente:**
   - Verifique firewall: `iptables -L -n`
   - Abra porta 5001: `iptables -A INPUT -p tcp --dport 5001 -j ACCEPT`
   - Salve regras: `iptables-save > /etc/iptables/rules.v4`

6. **Rollback autom√°tico:**
   - ‚úÖ **RESOLVIDO** - Sistema agora possui commit final for√ßado
   - ‚úÖ **RESOLVIDO** - Tratamento de exce√ß√µes aprimorado
   - ‚úÖ **RESOLVIDO** - Middleware protegido contra falhas

### **Logs e Debug:**

```bash
# Ver logs em tempo real
make logs

# Acesse shell do container
make shell

# Verifique status dos servi√ßos
make status

# Teste conectividade externa
curl -v http://101.44.2.109:5001/health
```

### **Verifica√ß√£o de Status:**

```bash
# Status dos containers
docker-compose ps

# Status da porta
netstat -tlnp | grep :5001

# Status do firewall
iptables -L -n

# Teste de conectividade
telnet 101.44.2.109 5001
```

## üéØ **Status das Implementa√ß√µes**

### **‚úÖ COMPLETADO:**

- ‚úÖ **Webhook para N8N** - Funcionando perfeitamente
- ‚úÖ **Processamento de respostas** - Automatizado
- ‚úÖ **Tratamento de rollbacks** - Resolvido
- ‚úÖ **Configura√ß√£o de firewall** - Implementada
- ‚úÖ **Conectividade externa** - Testada e funcionando
- ‚úÖ **Integra√ß√£o N8N** - Funcionando
- ‚úÖ **Sistema de logs** - Implementado
- ‚úÖ **Tratamento de erros** - Robusto

### **üöÄ PR√ìXIMOS PASSOS:**

- üîÑ **Testes automatizados** - Em desenvolvimento
- üìä **Dashboard de monitoramento** - Planejado
- üîî **Notifica√ß√µes em tempo real** - Planejado
- üì± **Interface web** - Planejado

---

## üèÜ **Sistema 100% Funcional**

O sistema est√° completamente funcional e pronto para produ√ß√£o:

- ‚úÖ **Webhook processando respostas do N8N**
- ‚úÖ **Banco de dados sendo atualizado automaticamente**
- ‚úÖ **Sem rollbacks autom√°ticos**
- ‚úÖ **Conectividade externa funcionando**
- ‚úÖ **Integra√ß√£o N8N operacional**
- ‚úÖ **Scheduler automatizado funcionando**
- ‚úÖ **CLI robusto para administra√ß√£o**

**üéâ Parab√©ns! O sistema est√° funcionando perfeitamente!**


